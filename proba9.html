<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8"/>
	<title>My Blog</title>
	<link rel="icon" type="image/x-icon" href="data:;base64,iVBORw0KGgo="/>
</head>
    <style>
    /* Global Styles */
    body {
        font-family: 'Arial', sans-serif;
        color: #333;
        background-color: #f0f0f0;
        line-height: 1.6;
    }

    a {
        color: #333;
        text-decoration: none;
    }

    a:hover {
        color: #5D93FF;
    }

    img {
        max-width: 100%;
        height: auto;
    }

    main {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
    }

    /* Post Styles */
    .post {
        background-color: #fff;
        margin-bottom: 20px;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.15);
    }

    .post-title {
        font-size: 24px;
        margin-bottom: 10px;
    }

    .post-content {
        font-size: 18px;
    }

    .post-date-time {
        font-size: 14px;
        color: #999;
        margin-top: 20px;
    }

    /* Post List Styles */
    #post-list {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    /* Most Viewed Posts Styles */
    .most-viewed-posts {
        list-style-type: none;
        padding: 0;
    }

    .most-viewed-posts .post-title {
        color: #333;
        font-size: 18px;
        margin-bottom: 5px;
    }
    
    /* Bulletin Styles */
    .bulletin {
        padding: 10px;
        border-bottom: 1px solid #ddd;
    }

    .bulletin:last-child {
        border-bottom: none;
    }
</style>
										    
<body>
<main>
	<h1>The blog is under construction</h1> 
	<div id="post-list"></div>
	<!-- Import the Firebase SDK -->
	<script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.9.1/firebase-database.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>	
 
    <script>
       // Initialize Firebase
      var firebaseConfig = {
        apiKey: "AIzaSyBB00grLIfvhq7EEQV6qiZUZuayP4-GoAg",
        authDomain: "blog-25253.firebaseapp.com",
        databaseURL: "https://blog-25253-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "blog-25253",
        storageBucket: "blog-25253.appspot.com",
        messagingSenderId: "906101390805",
        appId: "1:906101390805:web:871c51f2486921f443115c",
        measurementId: "G-MY3P2TWN4L"
      };
      firebase.initializeApp(firebaseConfig);	     
    </script>
  
<script>// break betwwen parts +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</script>

      <script>
	      // add newest posts // Place title before content on post1 --// 
// Get a reference to the posts in the database // add cached posts to localStorage
const postsRef = firebase.database().ref("posts");

// Get a reference to the post list element in the HTML
const postList = document.getElementById("post-list");

// Function to increment the read count of a post given its ID
function incrementReadCount(postId) {
  firebase.database().ref(`posts/${postId}`).transaction((post) => {
    if (post) {
      post.readCount = (post.readCount || 0) + 1;
    }
    return post;
  });
}
	      
// Create an array to hold the post elements
const postElements = [];
	      
// Helper function to create an element with given attributes
function createElement(tag, attributes, textContent) {
    const element = document.createElement(tag);
    Object.keys(attributes).forEach(key => {
        element[key] = attributes[key];
    });
    if (textContent) {
        element.textContent = textContent;
    }
    return element;
}

// Helper function to get cached data from localStorage
function getCachedData(key, defaultData) {
    let cachedData = localStorage.getItem(key);
    return cachedData ? JSON.parse(cachedData) : defaultData;
}

// Initialize Intersection Observer for lazy loading
const options = {
    root: null,
    rootMargin: '0px',
    threshold: 0.1
};

const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            const titleLink = entry.target;
            const postNumber = titleLink.dataset.postNumber;
            const postTitle = titleLink.dataset.postTitle;
            titleLink.innerText = getCachedData(`postTitle_${postNumber}`, postTitle);
            observer.unobserve(titleLink);
        }
    });
}, options);

// Get the cached content from localStorage, if available
let cachedPosts = getCachedData('category1-posts', []);

// Render the cached content, if available
if (cachedPosts.length > 0) {
    renderPosts(cachedPosts, true);
}

// Get the 10 newest posts from category1
postsRef.orderByChild("categoryid").equalTo("category1").limitToLast(10).on("value", (snapshot) => {
    const newPosts = [];
    snapshot.forEach((childSnapshot) => {
        newPosts.push(childSnapshot.val());
    });
    renderPosts(newPosts);
    localStorage.setItem('category1-posts', JSON.stringify(newPosts));
});

// Render the posts
function renderPosts(postsData, fromCache = false) {
    const postElements = postsData.map((postData, index) => {
        const postDiv = createElement("div", { className: "post" });

        if (index === 0) {
            const imageSrc = fromCache ? postData.postImage : getCachedData('postImage', postData.postImage);
            const image = createElement("img", { className: "post-image", src: imageSrc, loading: "lazy" });
            postDiv.appendChild(image);
            if (!fromCache) {
                localStorage.setItem('postImage', imageSrc);
            }
        }

        const titleLink = createElement("a", {
            className: "post-title",
            dataset: { postNumber: postData.postNumber, postTitle: postData.postTitle },
            href: `post.html?postId=${postData.postNumber}`,
            onclick: (event) => {
                event.preventDefault();
                incrementReadCount(postData.postNumber);
                window.location.href = titleLink.href;
            }
        });
        postDiv.appendChild(titleLink);
        observer.observe(titleLink);

        const postContent = fromCache ? postData.postContent : getCachedData(`postContent_${postData.postId}`, postData.postContent);
        const content = createElement("div", { className: "post-content" }, postContent.substring(0, 250) + '...');
        postDiv.appendChild(content);
        if (!fromCache) {
            localStorage.setItem(`postContent_${postData.postId}`, postData.postContent);
        }

        const postDate = moment(postData.postDate, "YYYY-MM-DD").format("MMMM D, YYYY");
        const postTime = moment(postData.postTime, "h:mm A").format("h:mm A");
        const postDateTime = createElement("div", { className: "post-date-time" },
            postDate === "Invalid date" || postTime === "Invalid date" ? "Invalid Date/Time" : `${postDate} at ${postTime}`);
        postDiv.appendChild(postDateTime);

        return postDiv;
    });

    postList.append(...postElements);
}	      
	      
	 


	      	      

// Get all posts from category2
postsRef.orderByChild("categoryid").equalTo("category2").on("value", (snapshot) => {
  // Loop through each post
  snapshot.forEach((childSnapshot) => {
    // Get the post data
    const postData = childSnapshot.val();

    // Create a div for the post
    const postDiv = document.createElement("div");
    postDiv.className = "post";

    // Create an image element for the post image
    const image = document.createElement("img");
    image.className = "post-image";
    image.src = postData.postImage;

    // Create a link element for the post title
    const titleLink = document.createElement("a");
    titleLink.className = "post-title";
    titleLink.innerText = postData.postTitle;
    titleLink.href = `post.html?postId=${childSnapshot.key}`;
    titleLink.addEventListener("click", (event) => {
      event.preventDefault();
      incrementReadCount(childSnapshot.key);
      window.location.href = titleLink.href;
    });

    // Create a div element for the post content
    const content = document.createElement("div");
    content.className = "post-content";
    content.innerText = `${postData.postContent.substring(0, 250)}...`;

    // Add the post content to the postDiv
    postDiv.appendChild(image);
    postDiv.appendChild(titleLink);
    postDiv.appendChild(content);

    // Add the postDiv to the postList
    postList.appendChild(postDiv);
  });
}); 	      
	      	      	      	      	        	      	      	      
	      
	// Function to increment the read count of a post given its ID
function incrementReadCount(postId) {
  firebase.database().ref(`posts/${postId}`).transaction((post) => {
    if (post) {
      post.readCount = (post.readCount || 0) + 1;
    }
    return post;
  });
}

// Function to create a post link with read count increment
function createPostLink(postId, postTitle) {
  const titleLink = document.createElement("a");
  titleLink.className = "post-title";
  titleLink.innerText = postTitle;
  titleLink.href = `post.html?postId=${postId}`;
  titleLink.addEventListener("click", (event) => {
    event.preventDefault();
    incrementReadCount(postId);
    window.location.href = titleLink.href;
  });
  return titleLink;
}  
	      
	      
// Get the 5 most viewed posts in descending order
const cachedPosts2 = localStorage.getItem('mostViewedPosts');
if (cachedPosts2) {
  document.body.appendChild(document.createRange().createContextualFragment(cachedPosts2));
} else {
  postsRef.orderByChild("readCount").limitToLast(5).on("value", (snapshot) => {
    const mostViewedPostsList = document.createElement("ul");
    mostViewedPostsList.classList.add("most-viewed-posts"); // Add class "most-viewed-posts" to the <ul> element
    const postElements = []; // create empty array to hold post elements
    snapshot.forEach((childSnapshot, index) => {
      const postData = childSnapshot.val();
      const postTitle = postData.postTitle;
      const listItem = document.createElement("li");
      listItem.classList.add("bulletin"); // Add class "bulletin" to the <li> element
      const titleLink = createPostLink(childSnapshot.key, postTitle);
      titleLink.classList.add("post-link"); // Add class "post-link" to the link element
      const postTitleClass = `post-title-${index + 1}`; // Generate unique class for each post title
      titleLink.classList.add(postTitleClass); // Add unique class to the link element for the post title
      listItem.appendChild(titleLink);
      postElements.push(listItem); // Add each item to the array
    });
    postElements.reverse(); // Reverse the array to add items in descending order
    postElements.forEach((listItem) => {
      mostViewedPostsList.appendChild(listItem); // Add each item to the list
    });
    document.body.appendChild(mostViewedPostsList);
    // Save the rendered posts to localStorage
    localStorage.setItem('mostViewedPosts', mostViewedPostsList.innerHTML);
  });
}
	      	      	
  // TODO: Navigate trough pages with page numbers 	      	      	
  // TODO: completely new CSS design
  // TODO: fetch to localStorage separatelly images, titles, content,media, etc... 
  // TODO: Main navigation config	      
	      
     </script>	
    </main>
  </body>
</html>	 
