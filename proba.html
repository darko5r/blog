<!DOCTYPE html>
<html>
  <head>
    <script src="https://www.gstatic.com/firebasejs/7.17.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.17.1/firebase-database.js"></script>
    <script>
      
   var firebaseConfig = {
		apiKey: "AIzaSyBB00grLIfvhq7EEQV6qiZUZuayP4-GoAg",
		authDomain: "blog-25253.firebaseapp.com",
		databaseURL: "https://blog-25253-default-rtdb.europe-west1.firebasedatabase.app",
		projectId: "blog-25253",
		storageBucket: "blog-25253.appspot.com",
		messagingSenderId: "906101390805",
		appId: "1:906101390805:web:871c51f2486921f443115c",
		measurementId: "G-MY3P2TWN4L"
	};

firebase.initializeApp(firebaseConfig);
var database = firebase.database();


document.addEventListener("keydown", function(event) {
	if (event.keyCode === 13) {
		event.preventDefault();
		submitLink();
	}
});


function submitLink() {
	var linkName = document.getElementById("linkName").value;
	var linkUrl = document.getElementById("linkUrl").value;

	if (!linkName || !linkUrl) {
		document.getElementById("errorMessage").innerHTML = "Both the link name and URL are required";
		return;
	}

	document.getElementById("errorMessage").innerHTML = "";
	document.getElementById("successMessage").innerHTML = "";
	var linksRef = database.ref("links");

	linksRef.orderByChild("id").limitToLast(1).once("value", function(snapshot) {
		var newId = 0;
		snapshot.forEach(function(childSnapshot) {
			var childData = childSnapshot.val();
			if (childData.id > newId) {
				newId = childData.id;
			}
		});
		newId++;

		linksRef.child(linkName).set({
			id: newId,
			url: linkUrl,
			timestamp: firebase.database.ServerValue.TIMESTAMP
		});

		document.getElementById("successMessage").innerHTML = "Link submitted successfully";
		document.getElementById("linkName").value = "";
		document.getElementById("linkUrl").value = "";
	});
}

function clearForm() {
	document.getElementById("errorMessage").innerHTML = "";
	document.getElementById("successMessage").innerHTML = "";
}

function clearName() {
	document.getElementById("linkName").value = "";
}

function clearUrl() {
	document.getElementById("linkUrl").value = "";
}


document.addEventListener("keydown", function(event) {
	if (event.keyCode === 46) {
		event.preventDefault();
		deleteLink();
	}
});

function deleteLink() {
	var linkName = document.getElementById("linkName").value;
	var linkUrl = document.getElementById("linkUrl").value;



	if (linkName && linkUrl && linkName === linkUrl) {
		document.getElementById("errorMessage").innerHTML = "The link name and URL are the same";
		return;
	}

	if (!linkName) {
		document.getElementById("errorMessage").innerHTML = "Link name is required";
		return;
	}

	document.getElementById("errorMessage").innerHTML = "";
	document.getElementById("successMessage").innerHTML = "";


	var linkRef = firebase.database().ref("links").child(linkName);

	linkRef.once("value", (snapshot) => {
		const link = snapshot.val();

		if (link === null) {
			document.getElementById("errorMessage").innerHTML = "Link not found in the database";
		} else {
			linkRef.remove();
			document.getElementById("successMessage").innerHTML = "Link deleted successfully";
			document.getElementById("linkName").value = "";
			document.getElementById("linkUrl").value = "";
		}
	});
}

// Add event listener to document to detect "Ctrl + R" key combination    
document.addEventListener("keydown", function(event) {
	if (event.ctrlKey && event.keyCode === 82) { // "Ctrl + R"
		event.preventDefault();
		resetInputs();
	}
});

// Reset input fields function     
function resetInputs() {
	document.getElementById("linkName").value = "";
	document.getElementById("linkUrl").value = "";
	document.getElementById("successMessage").innerHTML = "";
	document.getElementById("errorMessage").innerHTML = "";
}
	    

function toggleLinks() {
  var linkContainer = document.getElementById("linkContainer");
  if (linkContainer.style.display === "none") {
    linkContainer.style.display = "block";
    getLinks();
    document.getElementById("deleteSelectedBtn").addEventListener("click", function() {
      var linkList = document.getElementById("linkList");
      var checkboxes = linkList.getElementsByTagName("input");
      var checkedCheckboxes = linkList.querySelectorAll('input[type="checkbox"]:checked');
	    
      if (checkedCheckboxes.length === 0) {
        document.getElementById("errorMessage").innerHTML = "You need to select at least one checkbox";
        return;
      } else {
        document.getElementById("errorMessage").innerHTML = "";
      }
	    
      for (var i = 0; i < checkboxes.length; i++) {
        if (checkboxes[i].checked) { 
          database.ref("links").child(checkboxes[i].id).remove();
          checkboxes[i].parentNode.remove(); // Remove checkbox from the DOM
        }
      }
    });
  } else {
    linkContainer.style.display = "none";
  }
}	    
	    
	    

function getLinks() {
  var linksRef = database.ref("links");
  linksRef.once("value", function(snapshot) {
    var linkList = document.getElementById("linkList");
    linkList.innerHTML = "";
    snapshot.forEach(function(childSnapshot) {
      var linkName = childSnapshot.key;
      linkList.innerHTML += `
        <div>
          <input type="checkbox" id="${linkName}" name="linkCheckbox" />
          <label for="${linkName}">${linkName}</label>
        </div>
      `;	        
    });
  });
}

document.getElementById("deleteSelectedBtn").addEventListener("click", function() {
  var linkList = document.getElementById("linkList");
  var checkboxes = linkList.getElementsByTagName("input");
  for (var i = 0; i < checkboxes.length; i++) {
    if (checkboxes[i].checked) {
      database.ref("links").child(checkboxes[i].id).remove();
    }
  }
});
	    
	    
	    
document.getElementById("update-selected-links").addEventListener("click", updateSelectedLinks);
document.addEventListener("click", function(event) {
  if (event.target.closest("#link-list") || event.target.closest("#update-selected-links")) {
    return;
  }
  clearSelectedLinks();
});

function updateSelectedLinks() {
  var linkList = document.getElementById("link-list");
  var checkboxes = linkList.getElementsByTagName("input");
  var count = 0;
  var checkedLabels = [];

  for (let i = 0; i < checkboxes.length; i++) {
    if (checkboxes[i].type === "checkbox" && checkboxes[i].checked) {
      count++;

      // Check if input fields for this link already exist
      var existingInputFields = document.getElementById("input-fields-" + checkboxes[i].id);
      if (!existingInputFields) {
        // Create input fields and update button for this link
        var inputFields = document.createElement("div");
        inputFields.id = "input-fields-" + checkboxes[i].id;
        inputFields.className = "link-input-fields";
        
        
        var linkName = checkboxes[i].parentNode.querySelector("label").innerText;
        var linkNameText = linkName.split(" (")[0];
        var linkNameLabel = document.createElement("label");
        linkNameLabel.innerText = "Link name: " + linkNameText;
        var linkNameInput = document.createElement("input");
        linkNameInput.type = "text";
        linkNameInput.id = "link-name-input-" + checkboxes[i].id;
        linkNameInput.placeholder = "Link name";
        linkNameInput.value = linkNameText;
        linkNameInput.addEventListener("click", function() {
  this.select(); 
          });
        
        var linkURL = checkboxes[i].parentNode.querySelector("label").innerText;
        var linkURLText = linkURL.split(" (")[1].replace(")", ""); 
        var linkUrlInput = document.createElement("input");
        linkUrlInput.type = "text";
        linkUrlInput.id = "link-url-input-" + checkboxes[i].id;
        linkUrlInput.placeholder = "Link URL";
        linkUrlInput.value = linkURLText;
        linkUrlInput.addEventListener("click", function() {
  this.select(); 
          });
        
        var updateButton = document.createElement("button");
        updateButton.id = "update-button-" + checkboxes[i].id;
        updateButton.innerText = "Update";
        updateButton.addEventListener("click", function() {
          var newLinkName = linkNameInput.value;
          var newLinkUrl = linkUrlInput.value;
          if (newLinkName && newLinkUrl) {
            var oldRef = firebase.database().ref("links/" + checkboxes[i].id);
            var newRef = firebase.database().ref("links/" + newLinkName);
            oldRef.once("value", function(snapshot) {
              var updates = {};
              updates[newLinkName] = snapshot.val();
              updates[newLinkName].url = newLinkUrl;
              newRef.set(updates[newLinkName], function(error) {
                if (!error) {
                  oldRef.remove();
                  clearSelectedLinks();
                } else {
                  console.log("Error in updating the name of the child node: " + error);
                }
              });
            });
          }
        });

        inputFields.appendChild(linkNameInput);
        inputFields.appendChild(linkUrlInput);
        inputFields.appendChild(updateButton);

        // Add the input fields and update button to the page, limiting to 3 at once
        var currentInputFields = linkList.getElementsByClassName("link-input-fields");
        if (currentInputFields.length < 3) {
          linkList.appendChild(inputFields);
        } else {
          currentInputFields[0].remove();
          linkList.appendChild(inputFields);
        }
      }
    }
  }
  
  // Remove error message when a checkbox is checked
  for (let i = 0; i < checkboxes.length; i++) {
    if (checkboxes[i].type === "checkbox") {
      checkboxes[i].addEventListener("change", function() {
        if (this.checked) {
          removeLinkLimitError();
        }
      });
    }
  }
  
  if (count > 3) {
  var errorDiv = document.getElementById("link-limit-error");
  if (!errorDiv) {
    errorDiv = document.createElement("div");
    errorDiv.id = "link-limit-error";
    errorDiv.textContent = "You can only select up to three links";
    linkList.parentNode.insertBefore(errorDiv, linkList);
  } else {
    errorDiv.textContent = "You can only select up to three links";
  }
  
  if (Array.isArray(checkboxes)) {
    checkboxes.forEach(function(checkbox) {
      if (checkbox.checked && count > 3) {
        checkbox.checked = false;
        var inputFields = document.getElementById("input-fields-" + checkbox.id);
        if (inputFields) {
          inputFields.remove();
        }
        count--;
      }
    });
  }
      
    
        clearSelectedLinks();
  }
} 
      
      
      function clearSelectedLinks() {
  var linkList = document.getElementById("link-list");
  var inputs = linkList.getElementsByTagName("input");
  var inputFields = linkList.getElementsByClassName("link-input-fields");
  var updateButtons = linkList.getElementsByClassName("update-button");

  for (let i = inputs.length - 1; i >= 0; i--) {
    if (inputs[i].type === "checkbox" && inputs[i].checked) {
      inputs[i].checked = false;
    }
  }

  for (let i = inputFields.length - 1; i >= 0; i--) {
    linkList.removeChild(inputFields[i]);
  }

  for (let i = updateButtons.length - 1; i >= 0; i--) {
    linkList.removeChild(updateButtons[i]);
  }
}
      
      function removeLinkLimitError() {
  var errorDiv = document.getElementById("link-limit-error");
  if (errorDiv) {
    errorDiv.remove();
  }
}	    
   
	    
 </script>
  </head>
  <body>
    <input type="text" id="linkName" placeholder="Link Name" onfocus="clearForm();clearName();">
    <input type="text" id="linkUrl" placeholder="Link URL" onfocus="clearForm();clearUrl();">
    <div id="errorMessage" style="color: red;"></div>
    <div id="successMessage" style="color: green;"></div>
    <button onclick="submitLink()">Submit</button>
    <button onclick="deleteLink()">Delete</button>
    <button id="toggleButton" onclick="toggleLinks()">Toggle Links</button>
    <div id="linkContainer" style="display: none;">
    <div id="linkList"></div>
    <button id="deleteSelectedBtn">Delete Selected</button>
    <button id="update-selected-links">Update Selected</button>	    
    </div>
  </body>
</html>
